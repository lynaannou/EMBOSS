<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EMBOSS M√âTAL SERVICES</title>
  <link rel="stylesheet" href="../Styles/user.css" />
  <!-- Include ONCE -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
  <header>
    <div class="logo-title">
      <img src="logo-EMBOSS-nouveau.png" alt="Logo"/>
    </div>
    <nav>
      <a href="home.html">HOME</a>
      <a href="product.php">PRODUCT</a>
      <a href="catalogue.php">CATALOGUE</a>
      <a href="contact.html">CONTACT</a>
    </nav>
  </header>

  <div class="sign-up">
    <!-- LEFT -->
    <div class="left-section">
      <h1>SIGN UP</h1>

      <form id="signupForm" action="../../backend/user.php" method="post">
        <div class="form-row">
          <div class="form-group">
            <label for="user-name">Nom</label>
            <input type="text" id="user-name" name="user_name" placeholder="Entrez votre nom" />
          </div>
          <div class="form-group">
            <label for="user-lastname">Pr√©nom</label>
            <input type="text" id="user-lastname" name="user_lastname" placeholder="Entrez votre pr√©nom" />
          </div>
        </div>

        <label for="user-phone">T√©l√©phone</label>
        <input type="tel" id="user-phone" name="user_phone" placeholder="Entrez votre num√©ro de t√©l√©phone" />

        <label for="user-email">Email</label>
        <input type="email" id="user-email" name="user_email" placeholder="Entrez votre email" />

        <label for="user-password">Mot de passe</label>
        <input type="password" id="user-password" name="user_password" placeholder="Entrez votre mot de passe" />

        <label for="user-password-confirm">Confirmer le mot de passe</label>
        <input type="password" id="user-password-confirm" name="user_password_confirm" placeholder="Confirmez votre mot de passe" />

        <div class="checkbox-label">
          <input type="checkbox" id="contactable" name="contactable" />
          <label for="contactable">Voulez-vous √™tre contact√©(e) en cas de nouveaut√©es ?</label>
        </div>

        <div class="login-link">
          <h2>Already have an account?</h2><a href="login.html">Log in</a>
        </div>

        <button type="submit" class="submit-button">Sign up</button>

        <!-- Social / Google -->
        <div class="bottom-section">
          <div class="section-title-with-lines">
            <div class="line"></div>
            <h1>CONTINUER AVEC</h1>
            <div class="line"></div>
          </div>

          <div class="social-buttons">

            <!-- Google Identity Services: markup API (single block) -->
            <div id="g_id_onload"
                 data-client_id="570889304064-hrnd34ln9t5hav5ktj43vde6ldbc692n.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>

            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="pill"
                 data-theme="outline"
                 data-text="continue_with"
                 data-size="large">
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- RIGHT -->
    <div class="right-section">
      <img src="bkuser.jpg" alt="User Icon" class="bk-image" />
    </div>
  </div>

  <footer>
    <p>¬© 2025 EMBOSS M√âTAL SERVICES. Tous droits r√©serv√©s.</p>
    <div class="social-icons">
      <img src="facebook-icon.png" alt="Facebook" />
      <img src="linkedin-icon.png" alt="LinkedIn" />
      <img src="youtube-icon.png" alt="YouTube" />
      <img src="instagram-icon.png" alt="Instagram" />
    </div>
  </footer>

  <script>
    // Submit signup form via fetch + EmailJS
    document.getElementById("signupForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const response = await fetch("../../backend/user.php", { method: "POST", body: formData });
      const result = await response.json();

      if (result.success) {
        emailjs.init("0_GDw3aP_OABy1UoU");
        console.log("Envoi √† EmailJS :", {
          to_name: result.name,
          verify_link: result.verifyLink,
          email: result.email
        });

        emailjs.send("service_8pb9lxd", "template_qyfz245", {
          to_name: result.name,
          verify_link: result.verifyLink,
          email: result.email
        }).then(() => {
          alert("‚úÖ Email de v√©rification envoy√© !");
          setTimeout(() => window.location.href = "allez.html", 3000);
        }).catch(err => {
          console.error("Erreur EmailJS:", err);
          alert("‚ùå √âchec de l‚Äôenvoi de l‚Äôemail.");
        });
      } else {
        alert("Une erreur est survenue.");
      }
    });

    // Google Sign-In callback (posts ID token to backend)
    async function handleCredentialResponse(response) {
      try {
        const r = await fetch('../../backend/oauth_google.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ credential: response.credential })
        });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'unknown backend error');

        const u = data.user || {};
        localStorage.setItem("loggedIn", "true");
        localStorage.setItem("email", u.email || "");
        localStorage.setItem("username", u.name || "");
        localStorage.setItem("profileImage", u.picture || "avatar1.jpeg");
        localStorage.setItem("loginProvider", "google");

        window.location.href = "home.html";
      } catch (err) {
        console.error("Google sign-in error:", err);
        alert("Google sign-in failed.");
      }
    }
  </script>
  <!-- at the bottom of every page that has the header -->
<script type="module">
  import { enhanceHeader } from "../JS_Files/roles.js";
  // runs on DOMContentLoaded inside roles.js automatically;
  // importing once per page is enough.
</script>

  <script type="module">
  import { setRoleByEmail } from "../JS_Files/roles.js";

  window.handleCredentialResponse = async (response) => {
    try {
      const r = await fetch('../../backend/oauth_google.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ credential: response.credential })
      });
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'unknown backend error');

      const u = data.user || {};
      localStorage.setItem("loggedIn", "true");
      localStorage.setItem("email", (u.email || "").toLowerCase());
      localStorage.setItem("username", u.name || "");
      localStorage.setItem("profileImage", u.picture || "avatar1.jpeg");
      localStorage.setItem("loginProvider", "google");
      setRoleByEmail(u.email);                           // üëà set role

      window.location.href = "home.html";
    } catch (err) {
      console.error("Google sign-in error:", err);
      alert("Google sign-in failed.");
    }
  };
</script>

</body>
</html>
